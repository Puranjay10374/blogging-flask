{% extends "base.html" %}

{% block content %}
<div class="container">
    <article class="post">
        <header class="post-header">
            <h1>{{ post.title }}</h1>
            <div class="post-meta">
                <p>By <strong>{{ post.author.username }}</strong> on {{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                {% if post.updated_at > post.created_at %}
                    <p><em>Last updated: {{ post.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</em></p>
                {% endif %}
            </div>
        </header>
        
        <div class="post-content">
            {{ post.content|replace('\n', '<br>')|safe }}
        </div>
        
        <!-- Like Section -->
        <div class="post-engagement">
            <div class="like-section">
                {% if current_user.is_authenticated %}
                    <form method="POST" action="{{ url_for('blog.like_post', post_id=post.id) }}" class="like-form" id="like-form-{{ post.id }}">
                        <button type="submit" class="like-btn {{ 'liked' if post.is_liked_by(current_user) else '' }}" data-post-id="{{ post.id }}">
                            <span class="like-icon">
                                {% if post.is_liked_by(current_user) %}
                                    ‚ù§Ô∏è
                                {% else %}
                                    ü§ç
                                {% endif %}
                            </span>
                            <span class="like-text">
                                {{ 'Unlike' if post.is_liked_by(current_user) else 'Like' }}
                            </span>
                        </button>
                    </form>
                {% else %}
                    <span class="like-display">
                        <span class="like-icon">ü§ç</span>
                        <span class="like-text">Like</span>
                    </span>
                {% endif %}
                
                <span class="like-count" id="like-count-{{ post.id }}">
                    {% set like_count = post.get_like_count() %}
                    {% if like_count > 0 %}
                        {{ like_count }} {{ 'like' if like_count == 1 else 'likes' }}
                    {% else %}
                        No likes yet
                    {% endif %}
                </span>
            </div>
        </div>
        
        {% if current_user == post.author %}
            <div class="post-actions">
                <a href="{{ url_for('blog.edit', id=post.id) }}" class="btn btn-primary">Edit</a>
                <form method="POST" action="{{ url_for('blog.delete', id=post.id) }}" style="display: inline;" 
                      onsubmit="return confirm('Are you sure you want to delete this post?')">
                    <input type="submit" value="Delete" class="btn btn-danger">
                </form>
            </div>
        {% endif %}
    </article>
    
    <!-- Comments Section -->
    <section class="comments-section" id="comments">
        <div class="comments-header">
            <h3>Comments ({{ post.get_all_comments_count() }})</h3>
        </div>
        
        <!-- Add Comment Form -->
        {% if current_user.is_authenticated %}
            <div class="comment-form-container">
                <h4>Add a Comment</h4>
                <form method="POST" action="{{ url_for('blog.add_comment', post_id=post.id) }}" class="comment-form">
                    {{ comment_form.hidden_tag() }}
                    <div class="form-group">
                        {{ comment_form.content.label(class="form-label") }}
                        {{ comment_form.content(class="form-control") }}
                        {% if comment_form.content.errors %}
                            <div class="text-danger">
                                {% for error in comment_form.content.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {{ comment_form.submit(class="btn btn-primary") }}
                </form>
            </div>
        {% else %}
            <div class="comment-login-prompt">
                <p><a href="{{ url_for('auth.login') }}">Login</a> to leave a comment.</p>
            </div>
        {% endif %}
        
        <!-- Comments List -->
        <div class="comments-list">
            {% if comments %}
                {% for comment in comments %}
                    {% include 'blog/comment.html' %}
                {% endfor %}
            {% else %}
                <div class="no-comments">
                    <p>No comments yet. Be the first to comment!</p>
                </div>
            {% endif %}
        </div>
    </section>
    
    <div class="post-navigation">
        <a href="{{ url_for('blog.index') }}">&larr; Back to All Posts</a>
    </div>
</div>

<!-- Reply Form Modal Template (hidden by default) -->
<div class="reply-form-template" style="display: none;">
    <form method="POST" class="reply-form">
        {{ reply_form.hidden_tag() }}
        <div class="form-group">
            {{ reply_form.content.label(class="form-label") }}
            {{ reply_form.content(class="form-control") }}
        </div>
        <div class="reply-actions">
            {{ reply_form.submit(class="btn btn-primary btn-sm") }}
            <button type="button" class="btn btn-secondary btn-sm cancel-reply">Cancel</button>
        </div>
    </form>
</div>

<script>
// JavaScript for reply functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle reply button clicks
    document.querySelectorAll('.reply-btn').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const commentDiv = document.getElementById('comment-' + commentId);
            const existingReplyForm = commentDiv.querySelector('.reply-form');
            
            // Remove any existing reply forms
            document.querySelectorAll('.reply-form').forEach(form => {
                if (form.closest('.comment-item') !== commentDiv) {
                    form.remove();
                }
            });
            
            // Toggle reply form
            if (existingReplyForm) {
                existingReplyForm.remove();
                return;
            }
            
            // Create new reply form
            const template = document.querySelector('.reply-form-template');
            const replyForm = template.cloneNode(true);
            replyForm.style.display = 'block';
            replyForm.classList.remove('reply-form-template');
            replyForm.classList.add('reply-form-container');
            
            // Set the form action
            const form = replyForm.querySelector('form');
            form.action = '/comment/' + commentId + '/reply';
            
            // Add cancel functionality
            replyForm.querySelector('.cancel-reply').addEventListener('click', function() {
                replyForm.remove();
            });
            
            // Insert after comment content
            const commentContent = commentDiv.querySelector('.comment-content');
            commentContent.insertAdjacentElement('afterend', replyForm);
            
            // Focus on textarea
            replyForm.querySelector('textarea').focus();
        });
    });
});

// AJAX Like functionality
document.addEventListener('DOMContentLoaded', function() {
    const likeForm = document.querySelector('.like-form');
    if (likeForm) {
        likeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const postId = this.querySelector('.like-btn').getAttribute('data-post-id');
            const likeBtn = this.querySelector('.like-btn');
            const likeIcon = likeBtn.querySelector('.like-icon');
            const likeText = likeBtn.querySelector('.like-text');
            const likeCount = document.getElementById('like-count-' + postId);
            
            // Disable button temporarily
            likeBtn.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.querySelector('[name="csrf_token"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update button appearance
                    if (data.action === 'liked') {
                        likeBtn.classList.add('liked');
                        likeIcon.textContent = '‚ù§Ô∏è';
                        likeText.textContent = 'Unlike';
                    } else {
                        likeBtn.classList.remove('liked');
                        likeIcon.textContent = 'ü§ç';
                        likeText.textContent = 'Like';
                    }
                    
                    // Update like count
                    if (data.like_count > 0) {
                        likeCount.textContent = data.like_count + (data.like_count === 1 ? ' like' : ' likes');
                    } else {
                        likeCount.textContent = 'No likes yet';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                likeBtn.disabled = false;
            });
        });
    }
});
</script>
{% endblock %}
